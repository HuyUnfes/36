--[[ 
    BLOX FRUITS TOOLKIT: JOINER + AUTOLOAD + MIRAGE ESP (USER FIXED LOGIC)
    Integrated User's Robust Scan Code + Rounded UI + Auto Team
]]

local SourceCode = [==[

-- [[ 1. CH·ªú GAME LOAD & CHECK PLAYER ]] --
repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

repeat task.wait() until Players.LocalPlayer
local LocalPlayer = Players.LocalPlayer

--------------------------------------------------------------------------------
-- 2. AUTO PICK TEAM PIRATES
--------------------------------------------------------------------------------
task.spawn(function()
    while not LocalPlayer.Team or LocalPlayer.Team.Name == "Neutral" do
        pcall(function()
            local commF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")
            commF:InvokeServer("SetTeam", "Pirates")
        end)
        task.wait(1)
        if LocalPlayer.Team and LocalPlayer.Team.Name ~= "Neutral" then break end
    end
end)

--------------------------------------------------------------------------------
-- 3. ANTI-AFK
--------------------------------------------------------------------------------
local function activateAntiAfk()
    LocalPlayer.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end
activateAntiAfk()

--------------------------------------------------------------------------------
-- 4. H·ªÜ TH·ªêNG ESP MIRAGE ISLAND (LOGIC C·ª¶A B·∫†N ƒê√É ƒê∆Ø·ª¢C T√çCH H·ª¢P)
--------------------------------------------------------------------------------
local espEnabled = false
local foundMirage = false
local foundMirageObject = nil

local function sendNotification(title, text)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title;
            Text = text;
            Duration = 10;
        })
    end)
end

-- L·∫•y m·ªôt BasePart ƒë·∫°i di·ªán cho object
local function getRepresentativePart(object)
    if not object then return nil end
    if typeof(object) ~= "Instance" then return nil end

    if object:IsA("BasePart") then
        return object
    elseif object:IsA("Model") then
        if object.PrimaryPart and object.PrimaryPart:IsA("BasePart") then
            return object.PrimaryPart
        end
        local part = object:FindFirstChildWhichIsA("BasePart", true)
        return part
    end
    return nil
end

-- H√†m t·∫°o ESP (Theo logic b·∫°n cung c·∫•p)
local function createESP(object)
    if not object then return end

    local targetPart = getRepresentativePart(object)
    if not targetPart then return end

    if targetPart:FindFirstChild("MirageESP_Rounded") then return end

    local bgui = Instance.new("BillboardGui")
    bgui.Name = "MirageESP_Rounded"
    bgui.Adornee = targetPart
    bgui.Size = UDim2.new(0, 200, 0, 50)
    bgui.StudsOffset = Vector3.new(0, 100, 0) -- ƒê·∫©y cao l√™n cho d·ªÖ nh√¨n
    bgui.AlwaysOnTop = true
    bgui.Parent = targetPart

    local label = Instance.new("TextLabel")
    label.Parent = bgui
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 1, 0)
    label.TextColor3 = Color3.fromRGB(255, 0, 255)
    label.TextStrokeTransparency = 0
    label.TextStrokeColor3 = Color3.fromRGB(0,0,0)
    label.TextSize = 20
    label.Font = Enum.Font.GothamBlack
    label.TextWrapped = true

    -- Loop c·∫≠p nh·∫≠t text
    local updateLoop
    updateLoop = RunService.RenderStepped:Connect(function()
        if not espEnabled or not targetPart or not targetPart.Parent or not bgui then
            if updateLoop then updateLoop:Disconnect() end
            if bgui then bgui:Destroy() end
            return
        end

        if LocalPlayer and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local ok, dist = pcall(function()
                return math.floor((LocalPlayer.Character.HumanoidRootPart.Position - targetPart.Position).Magnitude)
            end)
            if ok and dist then
                label.Text = "üåë MIRAGE ISLAND üåë\n[" .. dist .. "m]"
            else
                label.Text = "üåë MIRAGE ISLAND üåë"
            end
        end
    end)

    -- Th√¥ng b√°o ban ƒë·∫ßu
    if LocalPlayer and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local distInit = math.floor((LocalPlayer.Character.HumanoidRootPart.Position - targetPart.Position).Magnitude)
        sendNotification("ƒê√É T√åM TH·∫§Y MIRAGE!", "C√°ch b·∫°n: " .. distInit .. "m")
    end
end

-- H√†m qu√©t Mirage (C·∫£i ti·∫øn theo y√™u c·∫ßu: ƒê·ªá quy + Case insensitive)
local function scanForMirage()
    local possibleNames = {"Mirage Island", "Mirage", "MirageIsland", "SeaEventIsland"}
    
    local function nameMatches(s)
        if not s then return false end
        local lower = string.lower(s)
        for _, nm in ipairs(possibleNames) do
            if string.find(lower, string.lower(nm), 1, true) then
                return true
            end
        end
        return false
    end

    -- 1. Qu√©t s√¢u (GetDescendants) nh∆∞ng l·ªçc Folder ƒë·ªÉ gi·∫£m lag
    local searchScope = {Workspace}
    -- N·∫øu c√≥ Map folder th√¨ ∆∞u ti√™n qu√©t trong ƒë√≥ tr∆∞·ªõc
    if Workspace:FindFirstChild("Map") then table.insert(searchScope, Workspace.Map) end

    for _, rootFolder in pairs(searchScope) do
        -- L∆∞u √Ω: GetDescendants r·∫•t n·∫∑ng, ta gi·ªõi h·∫°n qu√©t c√°c Model v√† Part l·ªõn
        for _, inst in ipairs(rootFolder:GetChildren()) do 
            -- Check t√™n tr·ª±c ti·∫øp
            if nameMatches(inst.Name) then return inst end
            
            -- Check con ch√°u (Deep Scan nh·∫π)
            -- Ch·ªâ deep scan n·∫øu object l√† Folder ho·∫∑c Model l·∫°
            if inst:IsA("Folder") or inst:IsA("Model") then
                if nameMatches(inst.Name) then return inst end
                -- T√¨m b√™n trong n√≥
                for _, child in ipairs(inst:GetChildren()) do
                    if nameMatches(child.Name) then return child end
                     -- Check MeshPart l·ªõn (fallback)
                    if child:IsA("BasePart") and child.Size.Magnitude > 2000 and string.find(string.lower(child.Name), "island") then
                        return child
                    end
                end
            end
        end
    end

    -- 2. Fallback: Check ƒë·∫•t d∆∞·ªõi ch√¢n (Ph√≤ng tr∆∞·ªùng h·ª£p t√™n b·ªã ƒë·ªïi ho√†n to√†n)
    -- ƒê√¢y l√† l·ªõp b·∫£o v·ªá cu·ªëi c√πng n·∫øu t√™n ƒë·∫£o b·ªã ƒë·ªïi
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") and char.Humanoid.FloorPart then
        local floor = char.Humanoid.FloorPart
        local model = floor:FindFirstAncestorOfClass("Model")
        if model and model.Name ~= "Map" and model.Name ~= "Workspace" and not model:FindFirstChild("Humanoid") and floor.Size.Magnitude > 100 then
            return model -- Tr·∫£ v·ªÅ model ƒëang ƒë·ª©ng l√™n n·∫øu n√≥ l·∫°
        end
    end

    return nil
end

local function toggleESP()
    espEnabled = not espEnabled
    if not espEnabled then
        foundMirage = false
        foundMirageObject = nil
        -- X√≥a s·∫°ch ESP c≈©
        for _, v in pairs(Workspace:GetDescendants()) do
            if v.Name == "MirageESP_Rounded" then v:Destroy() end
        end
    end
    return espEnabled
end

-- Helper Job ID
local function extractJobId(text)
    if not text then return nil end
    local pattern = "%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x"
    return string.match(text, pattern)
end

--------------------------------------------------------------------------------
-- 5. GIAO DI·ªÜN UI (ROUNDED)
--------------------------------------------------------------------------------
for _, v in pairs(CoreGui:GetChildren()) do
    if v.Name == "BloxFruitsToolRoundFix" then v:Destroy() end
end

local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local CloseButton = Instance.new("TextButton")
local InputBox = Instance.new("TextBox")
local StatusLabel = Instance.new("TextLabel")
local BtnJoinOnce = Instance.new("TextButton")
local BtnSpamJoin = Instance.new("TextButton")
local BtnESP = Instance.new("TextButton")

local function AddCorner(instance, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius)
    corner.Parent = instance
end

if syn and syn.protect_gui then syn.protect_gui(ScreenGui) ScreenGui.Parent = CoreGui
elseif gethui then ScreenGui.Parent = gethui()
else ScreenGui.Parent = CoreGui end

ScreenGui.Name = "BloxFruitsToolRoundFix"

-- Main Frame
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -130)
MainFrame.Size = UDim2.new(0, 320, 0, 260)
MainFrame.Active = true
MainFrame.Draggable = true
AddCorner(MainFrame, 12)

-- Title
Title.Parent = MainFrame
Title.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
Title.BackgroundTransparency = 1
Title.Position = UDim2.new(0, 15, 0, 0)
Title.Size = UDim2.new(0.8, 0, 0, 35)
Title.Font = Enum.Font.GothamBold
Title.Text = "BF Tool: Joiner & ESP (Fixed)"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextSize = 14

-- Close Button
CloseButton.Parent = MainFrame
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.Position = UDim2.new(1, -35, 0, 8)
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)
AddCorner(CloseButton, 6)

-- Input Box
InputBox.Parent = MainFrame
InputBox.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
InputBox.Position = UDim2.new(0.05, 0, 0.18, 0)
InputBox.Size = UDim2.new(0.9, 0, 0.18, 0)
InputBox.Font = Enum.Font.Code
InputBox.PlaceholderText = "Nh·∫≠p Discord Job ID..."
InputBox.Text = ""
InputBox.TextColor3 = Color3.fromRGB(220, 220, 220)
InputBox.TextSize = 12
InputBox.TextWrapped = true
InputBox.ClearTextOnFocus = true
AddCorner(InputBox, 8)

-- Status Label
StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.38, 0)
StatusLabel.Size = UDim2.new(1, 0, 0.1, 0)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "Tr·∫°ng th√°i: S·∫µn s√†ng"
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.TextSize = 12

-- BUTTONS
BtnJoinOnce.Parent = MainFrame
BtnJoinOnce.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
BtnJoinOnce.Position = UDim2.new(0.05, 0, 0.5, 0)
BtnJoinOnce.Size = UDim2.new(0.42, 0, 0.18, 0)
BtnJoinOnce.Font = Enum.Font.GothamBold
BtnJoinOnce.Text = "V√ÄO (1 L·∫ßn)"
BtnJoinOnce.TextColor3 = Color3.fromRGB(255, 255, 255)
BtnJoinOnce.TextSize = 12
AddCorner(BtnJoinOnce, 8)

BtnSpamJoin.Parent = MainFrame
BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(230, 126, 34)
BtnSpamJoin.Position = UDim2.new(0.53, 0, 0.5, 0)
BtnSpamJoin.Size = UDim2.new(0.42, 0, 0.18, 0)
BtnSpamJoin.Font = Enum.Font.GothamBold
BtnSpamJoin.Text = "SPAM V√ÄO"
BtnSpamJoin.TextColor3 = Color3.fromRGB(255, 255, 255)
BtnSpamJoin.TextSize = 12
AddCorner(BtnSpamJoin, 8)

BtnESP.Parent = MainFrame
BtnESP.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
BtnESP.Position = UDim2.new(0.05, 0, 0.72, 0)
BtnESP.Size = UDim2.new(0.9, 0, 0.2, 0)
BtnESP.Font = Enum.Font.GothamBold
BtnESP.Text = "T√åM MIRAGE (SCAN FIX)"
BtnESP.TextColor3 = Color3.fromRGB(255, 255, 255)
BtnESP.TextSize = 13
AddCorner(BtnESP, 8)

--------------------------------------------------------------------------------
-- 6. LOGIC K·∫æT N·ªêI
--------------------------------------------------------------------------------
local isSpamming = false

BtnJoinOnce.MouseButton1Click:Connect(function()
    isSpamming = false
    BtnSpamJoin.Text = "SPAM V√ÄO"
    BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(230, 126, 34)
    local id = extractJobId(InputBox.Text)
    if id then
        StatusLabel.Text = "ƒêang k·∫øt n·ªëi..."
        StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
        TeleportService:TeleportToPlaceInstance(game.PlaceId, id, LocalPlayer)
    else
        StatusLabel.Text = "ID kh√¥ng h·ª£p l·ªá!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
    end
end)

BtnSpamJoin.MouseButton1Click:Connect(function()
    if isSpamming then
        isSpamming = false
        BtnSpamJoin.Text = "SPAM V√ÄO"
        BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(230, 126, 34)
        StatusLabel.Text = "ƒê√£ d·ª´ng spam."
    else
        local id = extractJobId(InputBox.Text)
        if not id then StatusLabel.Text = "Ch∆∞a nh·∫≠p ID!" return end
        isSpamming = true
        BtnSpamJoin.Text = "D·ª™NG SPAM"
        BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(192, 57, 43)
        StatusLabel.Text = "ƒêang spam..."
        task.spawn(function()
            while isSpamming do
                if id == game.JobId then isSpamming = false break end
                pcall(function() TeleportService:TeleportToPlaceInstance(game.PlaceId, id, LocalPlayer) end)
                task.wait(2)
            end
        end)
    end
end)

BtnESP.MouseButton1Click:Connect(function()
    local state = toggleESP()
    if state then
        BtnESP.Text = "ƒêANG QU√âT S√ÇU..."
        BtnESP.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
        task.spawn(function()
            while espEnabled do
                if not foundMirage then
                    local mirage = scanForMirage()
                    if mirage then
                        foundMirage = true
                        foundMirageObject = mirage
                        createESP(mirage)
                        BtnESP.Text = "ƒê√É T√åM TH·∫§Y!"
                        StatusLabel.Text = "PH√ÅT HI·ªÜN MIRAGE!"
                        StatusLabel.TextColor3 = Color3.fromRGB(255, 0, 255)
                    else
                         StatusLabel.Text = "ƒêang t√¨m (ch∆∞a th·∫•y)..."
                         StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
                    end
                else
                    -- N·∫øu ƒë√£ t√¨m th·∫•y, check xem n√≥ c√≤n ƒë√≥ ko
                    if foundMirageObject and not foundMirageObject.Parent then
                         foundMirage = false
                         foundMirageObject = nil
                         BtnESP.Text = "ƒêANG QU√âT S√ÇU..."
                         StatusLabel.Text = "ƒê·∫£o bi·∫øn m·∫•t, t√¨m l·∫°i..."
                    end
                end
                task.wait(3) -- Qu√©t m·ªói 3s (v√¨ h√†m qu√©t n√†y n·∫∑ng h∆°n c≈©)
            end
        end)
    else
        BtnESP.Text = "T√åM MIRAGE (SCAN FIX)"
        BtnESP.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
        StatusLabel.Text = "ƒê√£ t·∫Øt t√¨m ƒë·∫£o."
    end
end)
]==]

-- [[ K√çCH HO·∫†T ]] --
loadstring(SourceCode)()

local queue_on_teleport = queue_on_teleport or (syn and syn.queue_on_teleport) or (fluxus and fluxus.queue_on_teleport) or (request and request.queue_on_teleport)
if queue_on_teleport then
    local payload = "local SourceCode = [==[" .. SourceCode .. "]==]; task.wait(3); loadstring(SourceCode)();"
    queue_on_teleport(payload)
end
