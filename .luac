--[[ 
    BLOX FRUITS TOOLKIT: JOINER + AUTOLOAD + MIRAGE ESP (OPTIMIZED)
    Updated by Request: Stronger Scan + Notification
]]

local SourceCode = [==[

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

--------------------------------------------------------------------------------
-- 1. H·ªÜ TH·ªêNG ANTI-AFK (Gi·ªØ k·∫øt n·ªëi)
--------------------------------------------------------------------------------
local function activateAntiAfk()
    LocalPlayer.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end
activateAntiAfk()

--------------------------------------------------------------------------------
-- 2. H·ªÜ TH·ªêNG ESP MIRAGE ISLAND (N√ÇNG C·∫§P)
--------------------------------------------------------------------------------
local espEnabled = false
local foundMirage = false -- Bi·∫øn ki·ªÉm tra ƒë·ªÉ kh√¥ng spam th√¥ng b√°o

-- H√†m g·ª≠i th√¥ng b√°o h·ªá th·ªëng
local function sendNotification(title, text)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title;
            Text = text;
            Duration = 10; -- Th·ªùi gian hi·ªán th√¥ng b√°o
            Icon = "rbxassetid://15277082958"; -- Icon Blox Fruits (n·∫øu c√≥) ho·∫∑c m·∫∑c ƒë·ªãnh
        })
    end)
end

-- H√†m t·∫°o ESP cho ƒê·∫£o
local function createESP(object)
    if object:FindFirstChild("MirageESP_Optimized") then return end 

    -- T√≠nh kho·∫£ng c√°ch ngay l·∫≠p t·ª©c ƒë·ªÉ th√¥ng b√°o
    local currentDist = "N/A"
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        currentDist = math.floor((LocalPlayer.Character.HumanoidRootPart.Position - object.Position).Magnitude)
    end

    -- G·ª¨I TH√îNG B√ÅO STARTER GUI NH∆Ø Y√äU C·∫¶U
    sendNotification("ƒê√É T√åM TH·∫§Y MIRAGE!", "Kho·∫£ng c√°ch: " .. currentDist .. " m√©t.\nH√£y nh√¨n theo h∆∞·ªõng ch·ªØ t√≠m!")

    -- T·∫°o UI ESP
    local bgui = Instance.new("BillboardGui")
    bgui.Name = "MirageESP_Optimized"
    bgui.Adornee = object
    bgui.Size = UDim2.new(0, 200, 0, 50)
    bgui.StudsOffset = Vector3.new(0, 150, 0) -- Cao h·∫≥n l√™n tr·ªùi cho d·ªÖ th·∫•y
    bgui.AlwaysOnTop = true 
    bgui.Parent = object

    local label = Instance.new("TextLabel")
    label.Parent = bgui
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 1, 0)
    label.TextColor3 = Color3.fromRGB(255, 0, 255) -- M√†u T√≠m Neon
    label.TextStrokeTransparency = 0
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.TextSize = 20
    label.Font = Enum.Font.GothamBlack -- Font ƒë·∫≠m d·ªÖ nh√¨n
    
    -- Loop c·∫≠p nh·∫≠t kho·∫£ng c√°ch (D√πng RunService cho m∆∞·ª£t m√† kh√¥ng t·ªën t√†i nguy√™n)
    local updateLoop
    updateLoop = RunService.RenderStepped:Connect(function()
        if not object or not object.Parent or not bgui or not espEnabled then
            updateLoop:Disconnect()
            if bgui then bgui:Destroy() end
            return
        end
        
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local dist = math.floor((LocalPlayer.Character.HumanoidRootPart.Position - object.Position).Magnitude)
            label.Text = "üåë MIRAGE ISLAND üåë\n[" .. dist .. "m]"
        end
    end)
end

-- H√†m qu√©t th√¥ng minh (Qu√©t m·∫°nh nh∆∞ng l·ªçc folder ƒë·ªÉ kh√¥ng lag)
local function scanForMirage()
    local possibleNames = {"Mirage Island", "Mirage", "MirageIsland"}
    
    -- Danh s√°ch c√°c n∆°i c·∫ßn qu√©t (Workspace, Map, v√† c√°c folder ·∫©n n·∫øu c√≥)
    local searchTargets = {Workspace}
    if Workspace:FindFirstChild("Map") then table.insert(searchTargets, Workspace.Map) end
    if Workspace:FindFirstChild("Locations") then table.insert(searchTargets, Workspace.Locations) end
    
    for _, folder in pairs(searchTargets) do
        for _, v in pairs(folder:GetChildren()) do
            -- Ki·ªÉm tra t√™n (k·ªÉ c·∫£ t√™n c√≥ ch·ª©a k√Ω t·ª± l·∫°)
            for _, name in pairs(possibleNames) do
                if v.Name == name or v.Name:find("Mirage") then
                    return v
                end
            end
            -- Ki·ªÉm tra MeshPart (ƒê√¥i khi ƒë·∫£o l√† 1 MeshPart l·ªõn)
            if v:IsA("MeshPart") and v.Name:find("Island") and v.Size.Magnitude > 2000 then
                 -- Logic ph·ª•: ƒê·∫£o mirage r·∫•t to, check size ƒë·ªÉ kh√¥ng nh·∫ßm ƒë·∫£o nh·ªè
                 return v
            end
        end
    end
    return nil
end

local function toggleESP()
    espEnabled = not espEnabled
    if not espEnabled then foundMirage = false end -- Reset tr·∫°ng th√°i t√¨m th·∫•y
    return espEnabled
end

--------------------------------------------------------------------------------
-- 3. H√ÄM L·ªåC JOB ID
--------------------------------------------------------------------------------
local function extractJobId(text)
    if not text then return nil end
    local pattern = "%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x"
    return string.match(text, pattern)
end

--------------------------------------------------------------------------------
-- 4. GIAO DI·ªÜN UI
--------------------------------------------------------------------------------
for _, v in pairs(CoreGui:GetChildren()) do
    if v.Name == "BloxFruitsToolv2" then v:Destroy() end
end

local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local CloseButton = Instance.new("TextButton")
local InputBox = Instance.new("TextBox")
local StatusLabel = Instance.new("TextLabel")
local BtnJoinOnce = Instance.new("TextButton")
local BtnSpamJoin = Instance.new("TextButton")
local BtnESP = Instance.new("TextButton")

if syn and syn.protect_gui then syn.protect_gui(ScreenGui) ScreenGui.Parent = CoreGui
elseif gethui then ScreenGui.Parent = gethui()
else ScreenGui.Parent = CoreGui end

ScreenGui.Name = "BloxFruitsToolv2"

-- Main Frame Styling
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -125)
MainFrame.Size = UDim2.new(0, 320, 0, 260)
MainFrame.Active = true
MainFrame.Draggable = true

-- Title
Title.Parent = MainFrame
Title.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.Font = Enum.Font.GothamBold
Title.Text = "  BF Tool: Joiner & Super ESP"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextSize = 14

-- Close Button
CloseButton.Parent = Title
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.Position = UDim2.new(1, -35, 0, 0)
CloseButton.Size = UDim2.new(0, 35, 0, 35)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

-- Input Box
InputBox.Parent = MainFrame
InputBox.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
InputBox.BorderSizePixel = 0
InputBox.Position = UDim2.new(0.05, 0, 0.18, 0)
InputBox.Size = UDim2.new(0.9, 0, 0.18, 0)
InputBox.Font = Enum.Font.Code
InputBox.PlaceholderText = "Nh·∫≠p Discord Job ID..."
InputBox.Text = ""
InputBox.TextColor3 = Color3.fromRGB(220, 220, 220)
InputBox.TextSize = 12
InputBox.TextWrapped = true
InputBox.ClearTextOnFocus = false

-- Status Label
StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.38, 0)
StatusLabel.Size = UDim2.new(1, 0, 0.1, 0)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "Tr·∫°ng th√°i: S·∫µn s√†ng"
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.TextSize = 12

-- BUTTON 1: JOIN ONCE
BtnJoinOnce.Parent = MainFrame
BtnJoinOnce.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
BtnJoinOnce.Position = UDim2.new(0.05, 0, 0.5, 0)
BtnJoinOnce.Size = UDim2.new(0.42, 0, 0.18, 0)
BtnJoinOnce.Font = Enum.Font.GothamBold
BtnJoinOnce.Text = "V√ÄO (1 L·∫ßn)"
BtnJoinOnce.TextColor3 = Color3.fromRGB(255, 255, 255)
BtnJoinOnce.TextSize = 12

-- BUTTON 2: SPAM JOIN
BtnSpamJoin.Parent = MainFrame
BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(230, 126, 34)
BtnSpamJoin.Position = UDim2.new(0.53, 0, 0.5, 0)
BtnSpamJoin.Size = UDim2.new(0.42, 0, 0.18, 0)
BtnSpamJoin.Font = Enum.Font.GothamBold
BtnSpamJoin.Text = "SPAM V√ÄO"
BtnSpamJoin.TextColor3 = Color3.fromRGB(255, 255, 255)
BtnSpamJoin.TextSize = 12

-- BUTTON 3: ESP MIRAGE
BtnESP.Parent = MainFrame
BtnESP.BackgroundColor3 = Color3.fromRGB(155, 89, 182) -- T√≠m ƒë·∫≠m
BtnESP.Position = UDim2.new(0.05, 0, 0.72, 0)
BtnESP.Size = UDim2.new(0.9, 0, 0.2, 0)
BtnESP.Font = Enum.Font.GothamBold
BtnESP.Text = "B·∫¨T T√åM ƒê·∫¢O MIRAGE (AUTO SCAN)"
BtnESP.TextColor3 = Color3.fromRGB(255, 255, 255)
BtnESP.TextSize = 13

--------------------------------------------------------------------------------
-- 5. LOGIC X·ª¨ L√ù
--------------------------------------------------------------------------------
local isSpamming = false

-- Logic Join Once
BtnJoinOnce.MouseButton1Click:Connect(function()
    isSpamming = false
    BtnSpamJoin.Text = "SPAM V√ÄO"
    BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(230, 126, 34)
    local id = extractJobId(InputBox.Text)
    if id then
        InputBox.Text = id
        StatusLabel.Text = "ƒêang k·∫øt n·ªëi..."
        StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
        TeleportService:TeleportToPlaceInstance(game.PlaceId, id, LocalPlayer)
    else
        StatusLabel.Text = "ID kh√¥ng h·ª£p l·ªá!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
    end
end)

-- Logic Spam Join
BtnSpamJoin.MouseButton1Click:Connect(function()
    if isSpamming then
        isSpamming = false
        BtnSpamJoin.Text = "SPAM V√ÄO"
        BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(230, 126, 34)
        StatusLabel.Text = "ƒê√£ d·ª´ng spam."
    else
        local id = extractJobId(InputBox.Text)
        if not id then StatusLabel.Text = "Ch∆∞a nh·∫≠p ID!" return end
        InputBox.Text = id
        isSpamming = true
        BtnSpamJoin.Text = "D·ª™NG SPAM"
        BtnSpamJoin.BackgroundColor3 = Color3.fromRGB(192, 57, 43)
        StatusLabel.Text = "ƒêang spam k·∫øt n·ªëi..."
        task.spawn(function()
            while isSpamming do
                if id == game.JobId then isSpamming = false break end
                pcall(function() TeleportService:TeleportToPlaceInstance(game.PlaceId, id, LocalPlayer) end)
                task.wait(1.5)
            end
        end)
    end
end)

-- Logic ESP Mirage Optimized
BtnESP.MouseButton1Click:Connect(function()
    local state = toggleESP()
    if state then
        BtnESP.Text = "ƒêANG QU√âT..."
        BtnESP.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
        
        task.spawn(function()
            while espEnabled do
                local mirage = scanForMirage()
                
                if mirage then
                    -- N·∫øu t√¨m th·∫•y
                    if not foundMirage then -- Ch·ªâ ch·∫°y 1 l·∫ßn khi m·ªõi t√¨m th·∫•y
                        foundMirage = true
                        createESP(mirage)
                        BtnESP.Text = "ƒê√É T√åM TH·∫§Y ƒê·∫¢O!"
                        StatusLabel.Text = "PH√ÅT HI·ªÜN MIRAGE!"
                        StatusLabel.TextColor3 = Color3.fromRGB(255, 0, 255)
                    end
                else
                    -- N·∫øu m·∫•t ƒë·∫£o (ƒë·∫£o bi·∫øn m·∫•t ho·∫∑c ƒë·ªïi server)
                    if foundMirage then
                        foundMirage = false -- Reset ƒë·ªÉ t√¨m l·∫°i l·∫ßn sau
                        BtnESP.Text = "ƒêANG QU√âT..."
                        StatusLabel.Text = "ƒê·∫£o ƒë√£ bi·∫øn m·∫•t..."
                        StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
                    end
                end
                
                -- N·∫øu ƒë√£ t√¨m th·∫•y th√¨ check ch·∫≠m l·∫°i cho ƒë·ª° lag, ch∆∞a t√¨m th·∫•y th√¨ check nhanh h∆°n x√≠u
                if foundMirage then
                    task.wait(5)
                else
                    task.wait(1.5) 
                end
            end
        end)
    else
        BtnESP.Text = "B·∫¨T T√åM ƒê·∫¢O MIRAGE (AUTO SCAN)"
        BtnESP.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
        StatusLabel.Text = "ƒê√£ t·∫Øt t√¨m ƒë·∫£o."
        -- X√≥a ESP
        for _, v in pairs(Workspace:GetDescendants()) do
            if v.Name == "MirageESP_Optimized" then v:Destroy() end
        end
    end
end)

]==]

-- [[ K√çCH HO·∫†T V√Ä AUTOLOAD CHU·∫®N ]] --
-- ƒêo·∫°n n√†y ƒë·∫£m b·∫£o khi b·∫°n tele sang server kh√°c, script s·∫Ω t·ª± ch·∫°y l·∫°i m√† kh√¥ng c·∫ßn inject
loadstring(SourceCode)()

local queue_on_teleport = queue_on_teleport or (syn and syn.queue_on_teleport) or (fluxus and fluxus.queue_on_teleport) or (request and request.queue_on_teleport)

if queue_on_teleport then
    -- ƒê√≥ng g√≥i to√†n b·ªô source code v√†o payload
    local payload = "local SourceCode = [==[" .. SourceCode .. "]==]; task.wait(3); loadstring(SourceCode)();"
    queue_on_teleport(payload)
end
